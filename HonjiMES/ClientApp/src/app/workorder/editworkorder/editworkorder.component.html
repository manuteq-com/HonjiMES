<form action="" (submit)="onFormSubmit($event)">
    <dx-form id="form" [formData]="formData" [readOnly]="readOnly" [showColonAfterLabel]="showColon"
        [labelLocation]="labelLocation" [minColWidth]="minColWidth" [colCount]="colCount" [width]="width">

        <dxi-item dataField="WorkOrderHeadId" [visible]="false">
            <dxo-label text="工單主檔ID"></dxo-label>
        </dxi-item>
        <dxi-item dataField="CreateTime" editorType="dxDateBox" [editorOptions]="CreateTimeDateBoxOptions"
            [visible]="modVisible">
            <dxi-validation-rule type="required" message="建立日期 必填"></dxi-validation-rule>
            <dxo-label text="建立日期"></dxo-label>
        </dxi-item>
        <dxi-item dataField="WorkOrderNo" [disabled]="true" [visible]="!modVisible">
            <dxo-label text="工單號"></dxo-label>
        </dxi-item>
        <dxi-item dataField="DataNo" [disabled]="true">
            <dxo-label text="品號"></dxo-label>
        </dxi-item>
        <dxi-item dataField="DataName" [disabled]="true">
            <dxo-label text="品名"></dxo-label>
        </dxi-item>
        <!-- <dxi-item dataField="OrderDetailId" dataType="number" editorType="dxSelectBox"
            [editorOptions]="ProductBasicSelectBoxOptions">
            <dxi-validation-rule type="required" message="訂單 必填"></dxi-validation-rule>
            <dxo-label text="訂單"></dxo-label>
        </dxi-item> -->
        <!-- <dxi-item dataField="ProductBasicId" dataType="number" editorType="dxSelectBox" [disabled]="true"
            [editorOptions]="ProductBasicSelectBoxOptions">
            <dxi-validation-rule type="required" message="成品項目 必填"></dxi-validation-rule>
            <dxo-label text="成品項目"></dxo-label>
        </dxi-item> -->
        <dxi-item dataField="Count" dataType="number" editorType="dxNumberBox" [disabled]="true">
            <dxi-validation-rule type="required" message="數量 必填"></dxi-validation-rule>
            <dxo-label text="數量"></dxo-label>
        </dxi-item>
        <!-- <dxi-item dataField="MachineNo" [disabled]="true">
            <dxo-label text="機號"></dxo-label>
        </dxi-item> -->
        <dxi-item dataField="CreateUser" [editorOptions]="UserEditorOptions" editorType="dxSelectBox">
            <dxi-validation-rule type="required" message="操作人員 必填"></dxi-validation-rule>
            <dxo-label text="操作人員"></dxo-label>
        </dxi-item>
        <dxi-item dataField="Remarks" [visible]="false" [disabled]="true">
            <dxo-label text="備註"></dxo-label>
        </dxi-item>

    </dx-form>
    <!-- <br> -->
    <!-- <div class="long-title">
        <h5>採購內容</h5>
    </div> -->
    <dx-data-grid #dataGrid2 [dataSource]="dataSourceDB" [showBorders]="true" keyExpr="Id" height="580"
        (onFocusedCellChanging)="onFocusedCellChanging($event)" (onInitNewRow)="onInitNewRow($event)"
        (onEditingStart)="onEditingStart($event)" (onCellPrepared)="onCellPrepared($event)"
        (onRowRemoved)="onRowRemoved($event)" (onSelectionChanged)="onSelectionChanged($event)"
        (onToolbarPreparing)="onToolbarPreparing($event)" (onEditorPreparing)="editorPreparing($event)"
        (onRowClick)="onRowClick($event)" [showColumnLines]="true" [showRowLines]="true"
        hoverStateEnabled="true">

        <dxo-editing mode="cell" [allowAdding]="false" [allowUpdating]="true" [allowDeleting]="false">
            <dxo-form colCount=4>
                <dxi-item dataField="SerialNumber"></dxi-item>
                <dxi-item dataField="ProcessId"></dxi-item>
                <dxi-item dataField="ProcessLeadTime"></dxi-item>
                <dxi-item dataField="ProcessTime"></dxi-item>
                <dxi-item dataField="ProcessCost"></dxi-item>
                <dxi-item dataField="ProducingMachine"></dxi-item>
            </dxo-form>
        </dxo-editing>

        <dxo-selection mode="multiple" showCheckBoxesMode="always"></dxo-selection>

        <dxi-column dataField="SerialNumber" caption="No" dataType="number" alignment="center" [width]="50" [allowEditing]="false"></dxi-column>
        <dxi-column dataField="ProcessId" caption="製程名稱" editCellTemplate="ProcessEditCellTemplate" [width]="260" [allowEditing]="false">
            <dxo-lookup [dataSource]="ProcessBasicList" displayExpr="Name" valueExpr="Id"></dxo-lookup>
            <dxi-validation-rule type="required" message="製程名稱 必填"></dxi-validation-rule>
        </dxi-column>
        <dxi-column dataField="Status" caption="目前狀態" alignment="center" [allowEditing]="false" [width]="80">
            <dxo-lookup [dataSource]="WorkStatusList" displayExpr="Name" valueExpr="Id"></dxo-lookup>
        </dxi-column>

        <dxi-column dataField="Type" caption="委外" alignment="center" [allowEditing]="false" [width]="80">
            <dxo-lookup [dataSource]="listWorkOrderTypes" displayExpr="Name" valueExpr="Id"></dxo-lookup>
        </dxi-column>

        <dxi-column dataField="ReCount" caption="完工" [allowEditing]="false" [width]="60"></dxi-column>
        <dxi-column dataField="NgCount" caption="NG" [allowEditing]="false" [width]="60"></dxi-column>
        <dxi-column dataField="ReportCount" caption="回報數量" dataType="number" editorType="dxNumberBox" [editorOptions]="editorOptions" [width]="80">
            <dxi-validation-rule type="custom" [validationCallback]="validateNumber" message="完工數量 必須 >= 0">
            </dxi-validation-rule>
        </dxi-column>
        <dxi-column dataField="ReportNgCount" caption="回報NG" dataType="number" editorType="dxNumberBox" [editorOptions]="editorOptions" [width]="80"></dxi-column>
        <dxi-column dataField="Message" caption="回報說明"></dxi-column>
        <dxi-column dataField="ProcessCost" caption="成本" dataType="number" format="$ #,##0.##;($ #,##0.##)" [width]="80" [allowEditing]="false" [visible]="false"></dxi-column>
        <!-- <dxi-column dataField="ProducingMachine" caption="機台" [width]="80"></dxi-column> -->
        <dxi-column dataField="ProducingMachine" caption="機台" editCellTemplate="ProducingMachineTemplate" [width]="80">
            <dxo-lookup [dataSource]="MachineList" displayExpr="Name" valueExpr="Name"></dxo-lookup>
            <dxi-validation-rule type="required" message="機台 必填"></dxi-validation-rule>
        </dxi-column>
        <dxi-column dataField="DueStartTime" caption="預計開工日" dataType="date" [allowEditing]="false" [width]="120"></dxi-column>
        <dxi-column dataField="DueEndTime" caption="預計完工日" dataType="date" [allowEditing]="false" [width]="120"></dxi-column>
        <dxi-column dataField="ActualStartTime" caption="實際開工日" dataType="date" format="shortDateShortTime" [width]="170" [allowEditing]="false"></dxi-column>
        <dxi-column dataField="ActualEndTime" caption="實際完工日" dataType="date" format="shortDateShortTime" [width]="170" [allowEditing]="false"></dxi-column>

        <!-- <dxi-column type="buttons">
            <dxi-button name="save" text="存檔"></dxi-button>
            <dxi-button name="cancel" text="取消" icon="redo"></dxi-button>
            <dxi-button name="edit" text="修改" type="success" icon="edit"></dxi-button>
            <dxi-button name="delete" text="刪除" icon="trash"></dxi-button>
        </dxi-column> -->

        <div *dxTemplate="let data of 'ProducingMachineTemplate'">
            <dx-select-box [value]="data.value"
                [dataSource]="{ paginate: true, store: { type: 'array', data: MachineList, key:'Name' } }"
                valueExpr="Name" displayExpr="Name" [searchEnabled]="true"></dx-select-box>
            <!-- <dx-text-box [value]="ProducingMachine" (onValueChanged)="data.setValue($event.value)"></dx-text-box> -->
        </div>

    </dx-data-grid>

    <div class="col-auto-12 mt-1">
        <dx-button horizontalAlignment="right" class="pl-3 pr-3 pb-1" text='批次報工' type='default' icon='runner'
            [useSubmitBehavior]="true" [disabled]="buttondisabled"></dx-button>
    </div>
</form>

<dx-popup [showTitle]="true" title="製程報工" [dragEnabled]="false" [closeOnOutsideClick]="false" [width]="800"
    [height]="ReportHeight" [(visible)]="creatpopupVisible">
    <div *dxTemplate="let data of 'content'">
        <app-workorder-report (childOuter)="creatpopup_result($event)" [itemkeyval]="itemkey" [serialkeyval]="serialkey" [popupkeyval]="creatpopupVisible"
            [modval]="mod" [randomkey]="randomkey"> </app-workorder-report>
    </div>
</dx-popup>
